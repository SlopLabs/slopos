# Phantom `w` Input Investigation (2026-02-22)

## Issue Summary

The shell periodically inserts literal `w` characters into the input line with no keyboard or mouse interaction.

User clarification (important):
- This is **real input**, not just a visual cursor artifact.
- The `w` characters accumulate in the command buffer over time.
- Commands fail because extra `w` characters are actually present in the typed line.

## Current Status

- **Uncommitted code changes were reverted** at user request.
- Repository is back to committed state before the temporary debugging/fix attempts below.

## What Was Investigated

### 1. Shell/UI rendering path (visual artifact hypothesis)

Reason:
- Periodic behavior initially looked like cursor blink redraw corruption.
- Recent commit message referenced prior "phantom-w" debugging.

Inspected:
- `userland/src/apps/shell/input.rs`
- `userland/src/apps/shell/display.rs`
- `gfx/src/canvas_font.rs`
- compositor cursor rendering in `userland/src/apps/compositor/renderer.rs`

Findings:
- There was a recent fix already in `bb5e4108d` changing cursor redraw behavior.
- Cursor blink path was plausible for a *visual* fake character.
- User explicitly confirmed the `w` is **inserted into input**, so rendering is not the root cause.

Temporary patch attempted (reverted):
- Changed shell cursor drawing to an underline rectangle instead of glyph redraw.
- Result: **did not fix** (real `w` input still occurred).

### 2. PS/2 keyboard/mouse IRQ demultiplexing (mouse bytes misread as keyboard)

Reason:
- Keyboard scancode `0x11` maps to `w`.
- Mouse packet/noise byte `0x11` could become a fake `w` if routed into keyboard scancode handling.
- Recent commit `bb5e4108d` unified keyboard and mouse IRQ handling and relies on PS/2 status bit 5 (`AUX`) classification.

Inspected:
- `drivers/src/irq.rs`
- `drivers/src/ps2/mod.rs`
- `drivers/src/ps2/keyboard.rs`
- `drivers/src/ps2/mouse.rs`

Key finding:
- `drivers/src/ps2/keyboard.rs` confirms `0x11 -> 'w'` in the scancode table.
- `bb5e4108d` mentions "remove temporary phantom-'w' instrumentation", so this exact symptom has already existed recently.

Temporary patches attempted (reverted):
- PS/2 handler: trust IRQ line (`IRQ1`/`IRQ12`) more than status AUX bit.
- PS/2 handler: drop parity/timeout error bytes before decoding.
- PS/2 handler: drain multiple pending controller bytes per IRQ invocation to avoid queue cross-contamination.

Result:
- **No fix** (user still sees periodic real `w` input).

### 3. TTY serial input path (COM1 RX mixed into shell input)

Reason:
- TTY merges keyboard input and COM1 serial RX.
- UART noise/host-side serial input could inject real characters without keyboard activity.

Inspected:
- `drivers/src/tty.rs`
- `drivers/src/serial.rs`
- `lib/src/ports.rs`
- `lib/src/io.rs`

Temporary patch attempted (reverted):
- Disabled serial RX contribution to TTY input stream (`keyboard-only` TTY input; serial output logging unchanged).

Result:
- **No fix** (user still sees periodic `w` input).

### 4. Syscall / TTY / shell input path sanity check

Inspected:
- `drivers/src/tty.rs`
- `userland/src/syscall/tty.rs`
- `core/src/syscall/core_handlers.rs`
- `userland/src/apps/shell/input.rs`

Findings:
- `try_read_char()` path appears logically correct (returns `-1` when no input).
- Shell insertion path only inserts printable bytes returned from TTY.
- No obvious stale-value bug found in the reviewed path.

### 5. IRQ dispatch framework sanity check

Inspected:
- `core/src/irq.rs`

Findings:
- IRQ dispatch and handler registration looked sane in the reviewed paths.
- No obvious evidence (yet) of IRQ line misregistration causing another device IRQ to call PS/2 handler.

## Commands Run / Validation Performed

- `cargo check -p slopos-drivers` (multiple times) ✅
- `cargo check -p slopos-userland` ✅
- `just boot-log` ✅ boots to kernel/userspace startup in headless mode (times out at normal 15s recipe timeout)

Note:
- Headless boot log was not sufficient to reproduce the interactive shell symptom.

## Most Important Evidence Collected

1. `w` corresponds to keyboard scancode make code `0x11`.
2. User confirmed the `w` is **actually inserted into the shell input buffer**.
3. Disabling serial RX from TTY input **did not help**.
4. Multiple PS/2 IRQ routing hardening attempts **did not help**.
5. Rendering/cursor path changes **did not help** (consistent with #2).

## Likely Remaining Root Causes (Ranked)

### A. Keyboard driver receives genuine repeated scancode `0x11` events

Could be caused by:
- Controller/device init sequencing issue leaving keyboard in odd state
- Repeated RESEND/ACK/self-test bytes being translated or misinterpreted later
- A stuck key state or spurious repeat generated by keyboard/controller emulation
- Another byte source still reaching `keyboard::handle_scancode()`

### B. Input byte source outside the reviewed TTY + PS/2 assumptions

Examples:
- Another input injection path writing into keyboard char buffer or TTY indirectly
- Unexpected device/IRQ interaction not visible in current code review

### C. PS/2 runtime state machine bug inside keyboard driver

Especially around:
- extended prefix (`0xE0`) state tracking
- make/break handling under malformed byte streams
- modifier state corruption leading to odd translations

## Recommended Next Steps (Concrete)

1. Add targeted keyboard instrumentation (temporary)
- In `drivers/src/ps2/keyboard.rs`, log only when `make_code == 0x11` or `ascii == b'w'`.
- Include: raw scancode, make/break, `extended_code` flag, modifier state, timestamp.
- Confirm whether the phantom event is a repeated **make** (`0x11`) and whether matching break (`0x91`) exists.

2. Add PS/2 source instrumentation at IRQ boundary (temporary)
- In `drivers/src/irq.rs`, for bytes routed to keyboard where `data == 0x11 || data == 0x91`, log:
  - IRQ line
  - PS/2 status byte
  - data byte
- This will prove whether the byte originates as keyboard vs AUX-tagged data.

3. Add a short-term diagnostic filter (not final fix)
- Drop `0x11` keyboard make events unless a plausible key sequence is observed (or gate behind debug cfg).
- Purpose: determine if suppressing only `0x11` eliminates the symptom without affecting other input.

4. Re-check keyboard init handshake behavior
- Audit `drivers/src/ps2/keyboard.rs::init()` against controller translation state and expected responses.
- Verify no device response bytes can leak into runtime keyboard path after IRQs are enabled.

5. If needed: capture longer serial/kernel logs with targeted instrumentation
- Headless `boot-log` is currently too short / not interactive.
- Use `just boot` with serial logging and wait for shell idle to observe phantom `w` events.

## Relevant Files

- `drivers/src/ps2/keyboard.rs`
- `drivers/src/ps2/mouse.rs`
- `drivers/src/ps2/mod.rs`
- `drivers/src/irq.rs`
- `drivers/src/tty.rs`
- `userland/src/apps/shell/input.rs`
- `userland/src/apps/shell/display.rs`
- `core/src/irq.rs`
- `core/src/syscall/core_handlers.rs`

## Relevant Commit

- `bb5e4108d` — `drivers,shell: harden PS/2 input path and cursor handling`
  - Commit message references prior phantom-`w` instrumentation/removal.

